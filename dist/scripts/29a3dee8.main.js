"use strict";var gDadb={mode:"",dragDiv:"",lastX:0,lastY:0,hoveredDivs:{}};!function(w,$){w.Dadb=function(parentId,userOptions){function _init(){if(_mergeOptions(),(_options.max-_options.min)%_options.step!==0)throw"Blocks length should be multiple to step";_build(),_createBlocksToolbar(),_openBlocks()}function _build(){$("#steps_"+parentId).remove(),$("#"+parentId).append('<div id="steps_'+parentId+'" class="DadbSteps"></div>');for(var a=$("#steps_"+parentId),b=(_options.max-_options.min)/_options.step,c=0,d="",e="",f=0;b>f;f++){c=f*_options.step%60,0===c?(d="DadbStepContentFullHour",e="DadbStepFullHour"):30===c?(d="DadbStepContentHalfHour",e="DadbStepHalfHour"):(d="DadbStepContentQuarter",e="DadbStepQuarter"),0===f&&(d+=" DadbStepContentStart",e+=" DadbStepStart"),f===b-1&&(d+=" DadbStepContentEnd",e+=" DadbStepEnd");var g=_options.min+f*_options.step;$("<div/>",{id:"step_"+parentId+"_"+(Number(f)+1),"class":e+" DadbStep",style:"width:"+_options.stepWidth+"px","data-start":g,html:'<span class="DadbTick">'+_options.stepLabelDispFormat(g)+'</span><div class="DadbStepContent '+d+'"></div></div>'}).appendTo(a)}a.append('<div><span class="DadbTick">'+_options.stepLabelDispFormat(_options.min+b*_options.step)+"</span></div>"),a.width(b*_options.stepWidth)}function _mergeOptions(){if(!userOptions)return _options;if("string"==typeof userOptions&&(userOptions=JSON.parse(userOptions)),"undefined"!=typeof userOptions.blocksToolbar&&"string"==typeof userOptions.blocksToolbar&&(userOptions.blocksToolbar=JSON.parse(userOptions.blocksToolbar)),"undefined"!=typeof userOptions.openBlocks&&"string"==typeof userOptions.openBlocks&&(userOptions.openBlocks=JSON.parse(userOptions.openBlocks)),"undefined"!=typeof userOptions.stepLabelDispFormat&&"string"==typeof userOptions.stepLabelDispFormat){var fn;eval("fn = "+userOptions.stepLabelDispFormat),userOptions.stepLabelDispFormat=fn}for(var optionKey in _options)if(optionKey in userOptions)switch(typeof _options[optionKey]){case"boolean":_options[optionKey]=!!userOptions[optionKey];break;case"number":_options[optionKey]=Math.abs(userOptions[optionKey]);break;case"string":_options[optionKey]=""+userOptions[optionKey];break;default:_options[optionKey]=userOptions[optionKey]}return _options}function _addBlocksToTolbar(a,b){var c,d=$(a);_options.readOnly||(c='<span> <i class = "DadbHandle fa fa-arrows"></i></span>');for(var e=0;e<b.length;e++){var f,g=$("<div/>",{id:"block"+b[e].value,"class":"DadbDraggableBlock DadbTemplate","data-value":b[e].value,"data-parentId":parentId,"data-toolbarId":_options.toolbarId,html:c}).appendTo(d);f="KID"===_options["class"]?"#ff7c34":"#00abe8",g.attr("data-color",f),g.attr("style","width:"+b[e].value/_options.step*_options.stepWidth+"px; background: "+f+";")}}function _createBlocksToolbar(){0===$("#"+_options.toolbarId).length&&$("#"+parentId).parent().append('<div id="'+_options.toolbarId+'" class="DadbSource"></div>'),_options.blocksToolbar.length>0&&_addBlocksToTolbar("#"+_options.toolbarId,_options.blocksToolbar),_options.readOnly||_createStampable()}function _onOver(a,b){if(b){var c,d,e;try{c=b.attr("data-value"),d=b.attr("data-toolbarId"),e=$(a.currentTarget)}catch(f){return}if("undefined"==typeof c)return void $(b.helper).css("color","red");var g;if(d===_options.toolbarId){var h=c/_options.step,i=gDadb.hoveredDivs,j=_getHoveredDivs(e,b,h,a);if(j!==i){g=h!==j.DadbEmpty.length?"DadbHighlightNOK":"DadbHighlightOK",_removeHighlight();for(var k=j.DadbStep.length,l=0;k>l;l++)0===l&&j.DadbStep[l].addClass(g+"start"),j.DadbStep[l].addClass(g),l===k-1&&j.DadbStep[l].addClass(g+"end")}}else _removeHighlight(),$("#"+parentId+" .DadbStep").addClass("DadbHighlightNOK")}}function _startStampDrag(a){a&&(gDadb.lastX=a.pageX,gDadb.lastY=a.pageY),gDadb.dragDiv&&gDadb.dragDiv.css({top:gDadb.lastY,left:gDadb.lastX})}function _stopStampDrag(){gDadb.dragDiv&&(gDadb.dragDiv.remove(),gDadb.dragDiv=null),$("div.DadbDraggableBlock").removeClass("Stamp"),$(".DadbSteps .DadbStep").unbind("click mouseup"),$("body").removeClass("unselectable")}function _createStampable(){function a(a,b,c){a.stopPropagation(),$("body").addClass("unselectable"),gDadb.mode=b;var d;d="drag"===b?$(c).closest("div.DadbDraggableBlock"):$(c),_removeHighlight(),a&&(gDadb.lastX=a.pageX,gDadb.lastY=a.pageY),d.hasClass("Stamp")?_stopStampDrag():(gDadb.dragDiv&&_stopStampDrag(),"stamp"===b&&d.addClass("Stamp"),$(document).unbind("mousemove").mousemove(_startStampDrag),gDadb.dragDiv=d.clone().addClass("FlyingStamp").css("position","absolute").appendTo("body"),_startStampDrag(),"drag"===b?$(document).unbind("click mouseup",_addClickOnToPutBlock).mouseup(_addClickOnToPutBlock):$(document).unbind("click mouseup",_addClickOnToPutBlock).click(_addClickOnToPutBlock))}$(document).unbind("keyup").keyup(function(a){27===a.keyCode&&(_removeHighlight(),_stopStampDrag(),$("div.DadbDraggableBlock.FlyingStamp").remove())}),$("#steps_"+parentId+".DadbSteps .DadbStep").mouseover(function(a){_onOver(a,gDadb.dragDiv)}),$("#"+_options.toolbarId).closest("table").unbind("click").click(function(){gDadb.dragDiv&&(_removeHighlight(),_stopStampDrag())}),$("div.DadbDraggableBlock span i.DadbHandle").unbind("mousedown").bind("mousedown",function(b){a(b,"drag",this)}),$("div.DadbDraggableBlock").unbind("click").click(function(b){a(b,"stamp",this)})}function _addClickOnToPutBlock(a){if(gDadb.dragDiv){var b=a.pageX-gDadb.hoveredDivs.lastX,c=a.pageY-gDadb.hoveredDivs.lastY,d=Math.sqrt(b*b+c*c);if(15>d){var e=gDadb.dragDiv.attr("data-value")/_options.step;gDadb.hoveredDivs.DadbEmpty.length===e&&_addSteps(gDadb.hoveredDivs.DadbEmpty,gDadb.dragDiv.attr("data-value"),gDadb.dragDiv.attr("data-color"),gDadb.hoveredDivs.calback)}_removeHighlight(),"drag"===gDadb.mode&&_stopStampDrag()}}function _getHoveredDivs(a,b,c,d){var e=a.attr("id");gDadb.hoveredDivs={},gDadb.hoveredDivs.DadbStep=[],gDadb.hoveredDivs.DadbEmpty=[];for(var f,g,h=0;c>h;h++)f=Number(e.replace("step_"+parentId+"_",""))+Number(h),g=$("#step_"+parentId+"_"+f),g.hasClass("DadbStep")&&gDadb.hoveredDivs.DadbStep.push(g),g.hasClass("DadbEmpty")&&gDadb.hoveredDivs.DadbEmpty.push(g);return d&&(gDadb.hoveredDivs.lastX=d.pageX,gDadb.hoveredDivs.lastY=d.pageY,gDadb.hoveredDivs.calback=_onAddBlock),gDadb.hoveredDivs}function _removeHighlight(){$("div.DadbStep").removeClass("DadbHighlightNOK").removeClass("DadbHighlightOK").removeClass("DadbHighlightOKstart").removeClass("DadbHighlightOKend").removeClass("DadbHighlightNOKstart").removeClass("DadbHighlightNOKend")}function _addSteps(a,b,c,d){if(!a[0].hasClass("DadbPlannedBlockBody")){for(var e,f=0;f<a.length;f++)a[f].removeClass("DadbEmpty"),a[f].addClass("DadbPlannedBlockBody"),a[f].attr("data-block-selector","DadbPlannedBlock_"+a[0].attr("id")),a[f].attr("data-color",c),a[f].css("background",c),0===f&&(a[f].addClass("DadbPlannedBlockStart"),a[f].attr("data-value",b),e=a[f]),f===a.length-1&&a[f].addClass("DadbPlannedBlockEnd");_options.readOnly||e.find("div").prepend('<span class="DadbCloser"><i class="DadbHandle fa fa-times"></i></span>').on("click",function(a){a.stopPropagation(),_removeBlock(this,d)}),"function"==typeof d&&d()}}function _removeBlock(a,b,c){var d,e,f;c?(d=parentId,e="#steps_"+parentId+".DadbSteps .DadbStep",f=$("#"+parentId+" div.DadbPlannedBlockBody")):(d=$(a).closest("div").parent().attr("id"),e="DadbPlannedBlock_"+d,f=$("[data-block-selector="+e+"]")),f.removeClass("DadbPlannedBlockBody").removeClass("DadbPlannedBlockStart").removeClass("DadbPlannedBlockEnd").addClass("DadbEmpty"),f.css("background-color",""),f.removeAttr("data-value"),f.removeAttr("data-block-selector"),f.removeAttr("data-color"),$("#"+d+" div.DadbStepContent").empty(),$("#"+d+" div.DadbStepContent").unbind("click"),_removeHighlight(),"function"==typeof b&&b()}function _getStepssInRange(a,b){for(var c=[],d=Number(a/_options.step)-Number(_options.min/_options.step)+1,e=b/_options.step,f=0;e>f;f++){var g=Number(d)+f;c.push($("#step_"+parentId+"_"+g))}return c}function _openBlocks(){_options.openBlocks.forEach(function(a){for(var b=_getStepssInRange(a[0],a[1]),c=0;c<b.length;c++)b[c].addClass("DadbEmpty"),b[c].attr("data-range-id",a[2])})}var _stepLabelDispFormat=function(a){var b=Math.floor(Math.abs(a)/60);return Math.abs(a)%60===0?(10>b&&b>=0?"0":"")+b:""},_options={"class":"KID",min:0,max:1440,step:15,stepWidth:17,stepLabelDispFormat:_stepLabelDispFormat,toolbarId:"blocksToolbar",attToolbarId:[],blocksToolbar:[],openBlocks:[],readOnly:!1},_onAddBlock=null,_onDeleteBlock=null;this.addBlocks=function(a){var b;b="KID"===_options["class"]?"#ff7c34":"#00abe8","string"==typeof a&&(a=JSON.parse(a));for(var c=[],d=0;d<a.length;d++)c=_getStepssInRange(a[d].start,a[d].value),_addSteps(c,a[d].value,b,_onAddBlock);return this},this.removeBlocks=function(){return _removeBlock(null,_onDeleteBlock,!0),this},this.getBlocks=function(){var a=[],b=$("div#"+parentId+" .DadbPlannedBlockStart");return b.length>0&&b.each(function(b,c){var d={};d.start=c.getAttribute("data-start"),d.value=c.getAttribute("data-value"),a.push(d)}),JSON.stringify(a)},this.setOnChangeCallback=function(a){return"function"==typeof a&&(_onAddBlock=a,_onDeleteBlock=a),this},this.getOnChangeCallback=function(){return _onAddBlock},this.changeStep=function(a){return _options.step=a,_build(),_openBlocks(),this},this.isStamp=function(){return gDadb.dragDiv},_init()}}(window,jQuery);